#!/bin/sh

export PATH="/bin/:/system/bin:/system/xbin"

SYSTEM=system.img
DATA=data.img

set_cmdline() {
  set -- $(cat /proc/cmdline)
  for arg in "$@"; do
    case "$arg" in
    ROOT=*) ROOT="${arg#*=}" ;;
    SRC=*) SRC="${arg#*=}" ;;
    SYSTEM=*) SYSTEM="${arg#*=}" ;;
    DATA=*) DATA="${arg#*=}" ;;
    GEARLOCK=*) GEARLOCK="${arg#*=}" ;;
    esac
  done
}

set_cmdline
ROOT=$(resolve_device "$ROOT")
BOOT_PART=$(resolve_device "$BOOT_PART")
SYSTEM=$(resolve_device "$SYSTEM")
DATA=$(resolve_device "$DATA")
GEARLOCK=$(resolve_device "$GEARLOCK")

. "${CONFIG:="/etc/gearlock.conf"}"

export ROOT \
  BOOT_PART \
  SRC \
  SYSTEM \
  DATA \
  GEARLOCK \
  SRCDIR \
  GEARLIB \
  GEARDATA \
  LOG \
  SYSTEM_TYPE

bash "$@"
