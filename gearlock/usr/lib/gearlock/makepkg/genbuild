#!/bin/bash
# Genbuild - a dependency-less package generator

die() { echo "==> ERROR: $1" >&2 && quit "${2:-1}"; }

quit() {
	cd "$CURRENT_DIR"
	rm -rf "$TMPDIR"
	exit "$?"
}

usage() {
	echo
}

while getopts "A:B:D:d:hl:M:m:N:o:P:p:r:S:s:u:v:t:" opt; do
	case "$opt" in
	A) ARCH="$OPTARG" ;;
	B) MAKEFILE="$OPTARG" ;;
	D) DESC="$OPTARG" ;;
	M) MAINTAINER="$OPTARG" ;;
	N) NAME=$OPTARG ;;
	# O) OUT=$OPTARG ;;
	P) PROVIDE_PRIOR="$OPTARG" ;;
	d) DEPENDS="${OPTARG//,/ }" ;;
	h) usage && exit ;;
	l) LICENSE=$OPTARG ;;
	m) MAKEDEPENDS="${OPTARG//,/ }" ;;
	o) OPTS=$OPTARG ;;
	p) PROVIDES="${OPTARG//,/ }" ;;
	r) REL=$OPTARG ;;
	S) NEEDED_SPACE=$((OPTARG * 2)) ;;
	s) SCRIPTS=$OPTARG ;;
	u) URL=$OPTARG ;;
	v) VER=$OPTARG ;;
	t) PKGTYPE="$OPTARG" ;;
	*) usage && exit 1 ;;
	esac
done
shift $((OPTIND - 1))

for arg in "$NAME" "$ARCH" "$MAINTAINER"; do
	[ "$arg" ] || exit 1
done

PKGTYPE=${PKGTYPE:-"$OSPKGTYPE"}
VER=${VER:-"0.0.1"}
REL=${REL:-"0"}
URL=${URL:-"https://android-x86.org/"}
# OUT=${OUT:-"/dev/stdout"}

TMPDIR=$("$GEARLIB"/checkfree "$NEEDED_SPACE") ||
	die "Not enough space to perform this action" 1

CURRENT_DIR=$(pwd)

move

cd "$TMPDIR"

case "$PKGTYPE" in
PKGBUILD | APKBUILD)
	cat <<EOF >>"${PKGTYPE}"
# Generated by Gearlock genbuild
# Maintainer: $MAINTAINER

pkgname=$NAME
pkgver=$VER
pkgrel=$REL
pkgdesc="$DESC"
url="$URL"
arch="$ARCH"
license="$LICENSE"
${OPTS:+"options=\"$OPTS\""}
${DEPENDS:+"depends=\"$DEPENDS\""}
${MAKEDEPENDS:+"makedepends=\"$MAKEDEPENDS\""}
${PROVIDES:+"provides=\"$PROVIDES\""}
${PROVIDE_PRIOR:+"provider_priority=\"$PROVIDE_PRIOR\""}
${SCRIPTS:+"install=\"$SCRIPTS\""}

check() {
	make check
}

build() {
	make VERSION="\$pkgver-\$pkgrel"
}

package() {
	mkdir -p "\$pkgdir"
	make install DESTDIR="\$pkgdir"
}

EOF
	;;
XBPS)
	cat <<EOF >>"template"
# Generated by Gearlock genbuild

maintainer='$MAINTAINER'
pkgname=$NAME
version=$VER
archs="$ARCH"
revision=$REL
short_desc="$DESC"
${URL:+"homepage=\"$URL\""}
license="$LICENSE"
${DEPENDS:+"depends=\"$DEPENDS\""}
${MAKEDEPENDS:+"makedepends=\"$MAKEDEPENDS\""}

do_build() {
	make VERSION=\$pkgver-\$revision
}

do_install() {
	mkdir -p "\$DESTDIR"
	make install DESTDIR="\$DESTDIR"
}

EOF
	;;
DEBIAN) ;;
*) ;;
esac

printf "%s" "$MAKEFILE" >Makefile

case "$PKGTYPE" in
APKBUILD) abuild -Ff; apk add --allow-untrusted /root/packages/*/*/"$NAME-$VER-r$REL.apk" ;;
PKGBUILD) chown -hR system:system . && su system -c 'makepkg -f' && pacman -U *.pkg.tar* ;;
XBPS) xbps-src pkg "$NAME" && do_something ;; #
DEBIAN) dpkg-buildpackage && dpkg -i ;;       #
*) ;;
esac ||
	die "Build package failed" 2

quit 0
