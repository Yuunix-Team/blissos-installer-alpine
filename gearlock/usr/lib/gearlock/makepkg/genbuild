#!/bin/bash

usage() {
	echo
}

while getopts "A:D:d:hI:l:M:m:O:o:P:p:r:u:v:t:" opt; do
	case "$opt" in
	A) ARCH="$OPTARG" ;;
	D) DESC="$OPTARG" ;;
	I) NAME=$OPTARG ;;
	M) MAINTAINER="$OPTARG" ;;
	O) OUT=$OPTARG ;;
	P) PROVIDE_PRIOR="$OPTARG" ;;
	d) DEPENDS="${OPTARG//,/ }" ;;
	h) usage && exit ;;
	l) LICENSE=$OPTARG ;;
	m) MAKEDEPENDS="${OPTARG//,/ }" ;;
	o) OPTS=$OPTARG ;;
	p) PROVIDES="${OPTARG//,/ }" ;;
	r) REL=$OPTARG ;;
	u) URL=$OPTARG ;;
	v) VER=$OPTARG ;;
	t) TYPE="$OPTARG" ;;
	*) usage && exit 1 ;;
	esac
done
shift $((OPTIND - 1))

for arg in "$NAME" "$ARCH" "$MAINTAINER"; do
	[ "$arg" ] || exit 1
done

if [ ! "$TYPE" ]; then
	for cmd in pacman xbps-src dpkg apk; do
		command -v $cmd || continue
		case "$cmd" in
		pacman) : "PKGBUILD" ;;
		xbps-src) : "XBPS" ;;
		dpkg) : "DEBIAN" ;;
		apk) : "APKBUILD" ;;
		esac
		TYPE=$_
		break
	done
fi

VER=${VER:-"0.0.1"}
REL=${REL:-"1"}
OUT=${OUT:-"/dev/stdout"}

case "$TYPE" in
PKGBUILD | APKBUILD)
	cat <<EOF >>"$OUT/${TYPE,,}"
# Generated by Gearlock genbuild
# Maintainer: $MAINTAINER

pkgname=$NAME
pkgver=$VER
pkgrel=$REL
pkgdesc="$DESC"
${URL:+"url=\"$URL\""}
arch="$ARCH"
license="$LICENSE"
${OPTS:+"options=\"$OPTS\""}
${DEPENDS:+"depends=\"$DEPENDS\""}
${MAKEDEPENDS:+"makedepends=\"$MAKEDEPENDS\""}
${PROVIDES:+"provides=\"$PROVIDES\""}
${PROVIDE_PRIOR:+"provider_priority=\"$PROVIDE_PRIOR\""}

build() {
	make VERSION="\$pkgver-\$pkgrel"
}

package() {
	make install DESTDIR="\$pkgdir"
}

EOF
	;;
XBPS)
	cat <<EOF >>"$OUT/template"
# Generated by Gearlock genbuild

maintainer='$MAINTAINER'
pkgname=$NAME
pkgver=$VER
revision=$REL
short_desc="$DESC"
${URL:+"homepage=\"$URL\""}
license="$LICENSE"
${DEPENDS:+"depends=\"$DEPENDS\""}
${MAKEDEPENDS:+"makedepends=\"$MAKEDEPENDS\""}


make VERSION=\$pkgver-\$revision

do_install() {
	make install DESTDIR="\$DESTDIR"
}

EOF
	;;
DEBIAN) ;;
*) ;;
esac
