#!/bin/bash

usage() {
	echo
}

die() { echo "==> ERROR: $1" >&2 && exit "${2:-1}"; }

while getopts "A:adpvh" opt; do
	case "$opt" in
	A) ARCH="$OPTARG" ;;
	a) : "APKBUILD" ;;
	d) : "DEBIAN" ;;
	p) : "PKGBUILD" ;;
	v) : "XBPS" ;;
	h) usage && exit ;;
	*) usage && exit 1 ;;
	esac
	TYPE=$_
done
shift $((OPTIND - 1))

FILE=$1

if [ ! "$TYPE" ]; then
	for cmd in pacman xbps-src dpkg apk; do
		command -v $cmd || continue
		case "$cmd" in
		pacman) : "PKGBUILD" ;;
		xbps-src) : "XBPS" ;;
		dpkg) : "DEBIAN" ;;
		apk) : "APKBUILD" ;;
		esac
		TYPE=$_
		break
	done
fi

: "${ARCH:="$(busybox arch)"}"

if grep -q " ROOT=" /proc/cmdline 2>/dev/null; then
	TMPDIR=$SRCDIR/tmp
	[ -d "$TMPDIR" ] || mkdir -p "$TMPDIR"
else
	TMPDIR=/data/local/tmp
fi

# FREESPACES and FREESPACE are different
FREESPACES=($("$GEARLIB"/checkfree))

NEEDED_SPACE=$("$GEARLIB"/decompsize "$FILE")

if [ "$COPYTORAM" = true ]; then
	TMPSPACE=${FREESPACES[1]}
	((NEEDED_SPACE > TMPSPACE)) &&
		echo "COPYTORAM is enabled, but there's not enough RAM to perform this action, falling back..." &&
		TMPSPACE=${FREESPACES[0]} ||
		mount -t tmpfs -o rw,nodev,nosuid,size=$((TMPSPACE + 4096))K,mode=1770 tmpfs "$TMPDIR"
	FREESPACE=$TMPSPACE
else
	FREESPACE=${FREESPACES[0]}
fi

((NEEDED_SPACE > FREESPACE)) &&
	exit 3

# TODO: check for module.prop (magisk module format) & system.img (if it's a rom)

content=$(unzip -l "$FILE")
if echo "$content" | grep -q module.prop; then
	"$GEARLIB"/extract "$FILE" "$TMPDIR" module.prop
	eval "$(sed -r "s/^([a-zA-Z0-9_]+[a-zA-Z0-9_-]*=)(.*)$/\1\"\2\"/g" "$TMPDIR/module.prop" | tr '\n' ' ')"
elif echo "$content" | grep -Eq "system(_[ab])?.img"; then
	die "'$FILE' is a ROM and not supported" 2
else
	echo "WARNING: '$FILE' is not a ksu/magisk package. Parsing from file name..."
	eval "$(echo $FILE | awk -F '-' '{
name=$1
for(i=2;i<=NF;i++) {
	switch ($i) {
	case /[0-9]+\..*/ :
		ver=$i
		break
	case /[0-9]{8}/ :
		date=$i
		if ($ver !) {ver=$i}
		break
	case /(x86_?|arm|aarch)(32|64|eabi|hf)?/ :
		arch=$i
		break
	}
}
print "id=\""$name"\" version=\""$ver"\" arch=\""$arch"\" desc=\""$name" - build date: "$date"\"" 
}')"

fi

"$GEARLIB"/extract "$FILE" "$TMPDIR"

# TODO: simulate a magisk/ksu environment to install flashable zips

mkdir -p "$TMPDIR/$GEARDATA/extension/"

# first extract zip/brotli, then create binded package, then install it
