#!/bin/sh

export PATH="/bin/:/system/bin:/system/xbin"

SYSTEM=system.img
DATA=data.img

set -- $(cat /proc/cmdline)
for arg in "$@"; do
  case "$arg" in
  ROOT=*) ROOT="${arg#*=}" ;;
  SRC=*) SRC="${arg#*=}" ;;
  SYSTEM=*) SYSTEM="${arg#*=}" ;;
  DATA=*) DATA="${arg#*=}" ;;
  GEARLOCK=*) GEARLOCK="${arg#*=}" ;;
  esac
done

uuidlabel() {
  case "$1" in
  LABEL=* | UUID=*) resolve_device "$1" ;;
  *) echo "$1" ;;
  esac
}

ROOT=$(uuidlabel "$ROOT")
BOOT_PART=$(uuidlabel "$BOOT_PART")
SYSTEM=$(uuidlabel "$SYSTEM")
DATA=$(uuidlabel "$DATA")
GEARLOCK=$(uuidlabel "$GEARLOCK")

. "${CONFIG:="/etc/gearlock.conf"}"

export ROOT \
  BOOT_PART \
  SRC \
  SYSTEM \
  DATA \
  GEARLOCK \
  SRCDIR \
  GEARLIB \
  GEARDATA \
  LOG \
  SYSTEM_TYPE

bash $@
