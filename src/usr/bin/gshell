#!/bin/sh

. "${CONFIG:="/etc/gearlock.conf"}"

export PATH="/bin/:/system/bin:/system/xbin"

export SRCDIR
export LOG
export SYSTEM_TYPE

SYSTEM=system.img
DATA=data.img

set -- $(cat /proc/cmdline)
for arg in "$@"; do
  case "$arg" in
  ROOT=*) ROOT="${arg#*=}" ;;
  SRC=*) SRC="${arg#*=}" ;;
  SYSTEM=*) SYSTEM="${arg#*=}" ;;
  DATA=*) DATA="${arg#*=}" ;;
  GEARLOCK=*) GEARLOCK="${arg#*=}" ;;
  esac
done

case "$ROOT" in
LABEL=* | UUID=*) ROOT=$(resolve_device "$ROOT") ;;
esac

case "$SYSTEM" in
LABEL=* | UUID=*) SYSTEM=$(resolve_device "$SYSTEM") ;;
esac

case "$DATA" in
LABEL=* | UUID=*) DATA=$(resolve_device "$DATA") ;;
esac

case "$GEARLOCK" in
LABEL=* | UUID=*) GEARLOCK=$(resolve_device "$GEARLOCK") ;;
esac

case "$BOOT_PART" in
LABEL=* | UUID=*) BOOT_PART=$(resolve_device "$BOOT_PART") ;;
esac

export ROOT BOOT_PART SRC SYSTEM DATA GEARLOCK

bash $@
